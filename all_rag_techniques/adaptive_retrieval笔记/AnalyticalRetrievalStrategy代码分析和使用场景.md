ä½ è¿™æ®µä»£ç æ˜¯ä¸€ä¸ªéå¸¸ç»å…¸çš„ **â€œåˆ†æå‹æŸ¥è¯¢çš„æ–‡æ¡£æ£€ç´¢ç­–ç•¥â€**ï¼Œåœ¨ä¸€ä¸ªåŸºäº RAGï¼ˆRetrieval-Augmented Generationï¼‰çš„ç³»ç»Ÿä¸­ç”¨äºæ”¯æŒ **å¤æ‚ã€éœ€è¦æ‹†è§£çš„åˆ†æå‹é—®é¢˜**ã€‚æˆ‘ä»¬ä¸‹é¢è¯¦ç»†æ‹†è§£æ¯ä¸€æ®µä»£ç çš„ä½œç”¨ã€æµç¨‹ï¼Œå¹¶é…ä¸Š**é€šä¿—è§£é‡Š + æ•°å€¼ç¤ºä¾‹**ï¼Œæœ€åå†æ€»ç»“**é€‚ç”¨åœºæ™¯**ã€‚

---

# ğŸ§  ä¸€å¥è¯æ€»ç»“ï¼š

> è¿™æ˜¯ä¸€ä¸ªç”¨ LLM è‡ªåŠ¨æ‹†åˆ†å¤æ‚é—®é¢˜ä¸ºå­é—®é¢˜ã€æ£€ç´¢å¤šä¸ªç›¸å…³æ–‡æ¡£ã€å†ç”¨ LLM ä»ä¸­ç­›é€‰å‡ºå¤šæ ·ä¸”ç›¸å…³æ–‡æ¡£çš„â€œåˆ†æå‹æ£€ç´¢ç­–ç•¥â€ã€‚

---

## âœ… å…¨æµç¨‹é€»è¾‘æ¦‚è§ˆï¼ˆå›¾å¼ï¼‰

```
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   ç”¨æˆ·æé—®   â”‚ â†’ query = "çº½çº¦çš„æ•´ä½“ç»æµçŠ¶å†µå¦‚ä½•ï¼Ÿ"
         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ â‘  ä½¿ç”¨ LLM æ‹†åˆ†æˆå­é—®é¢˜ SubQueries â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ â‘¡ æ¯ä¸ªå­é—®é¢˜éƒ½åš similarity_search â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ â‘¢ ç”¨ LLM æŒ‘é€‰å¤šæ ·ã€æœ€ç›¸å…³çš„æ–‡æ¡£ k ä¸ª â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
     âœ… è¿”å›æœ€ç»ˆ selected docs
```

---

## ğŸ§© ç±»å®šä¹‰éƒ¨åˆ†ï¼ˆPydantic æ•°æ®æ¨¡å‹ï¼‰

```python
class SelectedIndices(BaseModel):
    indices: List[int] = Field(description="Indices of selected documents", example=[0, 1, 2, 3])
```

* å®šä¹‰ä¸€ä¸ª Pydantic ç±»ï¼Œè¡¨ç¤ºæœ€ç»ˆé€‰ä¸­çš„æ–‡æ¡£ç´¢å¼•ï¼ˆç”¨äº LLM è¾“å‡ºç»“æ„åŒ–ç»“æœï¼‰
* ä¸¾ä¾‹ï¼š`[0, 2, 5, 7]` è¡¨ç¤ºæˆ‘ä»¬ä»æ‰€æœ‰æ–‡æ¡£ä¸­é€‰å‡ºäº†è¿™å‡ ä¸ªä½ç½®çš„å†…å®¹ã€‚

```python
class SubQueries(BaseModel):
    sub_queries: List[str] = Field(description="List of sub-queries", example=[
        "What is the population of New York?", 
        "What is the GDP of New York?"
    ])
```

* ç”¨äºæ¥æ”¶ LLM ç”Ÿæˆçš„å­é—®é¢˜ç»“æœï¼ˆç»“æ„åŒ– List\[str]ï¼‰

---

## ğŸ§  ä¸»é€»è¾‘ç±» `AnalyticalRetrievalStrategy`

```python
class AnalyticalRetrievalStrategy(BaseRetrievalStrategy):
    def retrieve(self, query, k=4):
```

* å®ç°ä¸€ä¸ªæ£€ç´¢ç­–ç•¥ç±»ï¼ˆä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºä¸€ä¸ªâ€œæ’ä»¶â€ï¼Œç”¨äºå¤„ç†ç‰¹å®šç±»å‹é—®é¢˜ï¼‰
* `query` æ˜¯ç”¨æˆ·åŸå§‹é—®é¢˜
* `k=4` è¡¨ç¤ºæˆ‘ä»¬æœ€ç»ˆå¸Œæœ›é€‰å‡º 4 ä¸ªç›¸å…³æ–‡æ¡£è¿”å›

---

## â‘  ä½¿ç”¨ LLM æ‹†è§£é—®é¢˜æˆå­é—®é¢˜ï¼ˆSubQueriesï¼‰

```python
sub_queries_prompt = PromptTemplate(
    input_variables=["query", "k"],
    template="Generate {k} sub-questions for: {query}"
)
llm = ChatOpenAI(...)
sub_queries_chain = sub_queries_prompt | llm.with_structured_output(SubQueries)

input_data = {"query": query, "k": k}
sub_queries = sub_queries_chain.invoke(input_data).sub_queries
```

### âœ¨ å«ä¹‰ï¼š

* è°ƒç”¨ GPT-4o å» **æ ¹æ®ç”¨æˆ·çš„ä¸»é—®é¢˜ç”Ÿæˆ k ä¸ªå­é—®é¢˜**ã€‚
* è¾“å‡ºç»“æ„åŒ–æ ¼å¼ï¼ˆé€šè¿‡ `.with_structured_output(...)`ï¼‰ä¿è¯æ˜¯ `List[str]`

### ğŸ§ª æ•°å€¼ç¤ºä¾‹ï¼š

å¦‚æœç”¨æˆ· query æ˜¯ï¼š

```text
â€œçº½çº¦çš„æ•´ä½“ç»æµçŠ¶å†µå¦‚ä½•ï¼Ÿâ€
```

åˆ™ LLM å¯èƒ½è¿”å›å­é—®é¢˜ï¼ˆk=4ï¼‰ï¼š

```python
sub_queries = [
    "What is the GDP of New York?",
    "What is the unemployment rate in New York?",
    "What are the major industries in New York?",
    "How has the economy of New York changed over time?"
]
```

---

## â‘¡ é’ˆå¯¹å­é—®é¢˜é€ä¸ªåšæ£€ç´¢

```python
all_docs = []
for sub_query in sub_queries:
    all_docs.extend(self.db.similarity_search(sub_query, k=2))
```

### âœ¨ å«ä¹‰ï¼š

* å¯¹æ¯ä¸ªå­é—®é¢˜ï¼Œç”¨å‘é‡æ•°æ®åº“ï¼ˆæˆ–æ£€ç´¢å¼•æ“ï¼‰æ£€ç´¢å‡º 2 ä¸ªæœ€ç›¸å…³æ–‡æ¡£ã€‚
* ä½¿ç”¨ `.extend()` æŠŠæ‰€æœ‰æ–‡æ¡£æ‰å¹³åŠ å…¥åˆ° `all_docs`ã€‚

### ğŸ§ª æ•°å€¼ç¤ºä¾‹ï¼š

å¦‚æœæ¯ä¸ªå­é—®é¢˜è¿”å› 2 ç¯‡æ–‡æ¡£ï¼Œæ€»å…± 4 ä¸ªå­é—®é¢˜ï¼Œå°±æœ‰ 8 ç¯‡æ–‡æ¡£ï¼š

```python
all_docs = [
    doc0, doc1,  # GDP
    doc2, doc3,  # Unemployment
    doc4, doc5,  # Industries
    doc6, doc7   # History
]
```

---

## â‘¢ ç”¨ LLM è¯„ä¼°å¤šæ ·æ€§ + ç›¸å…³æ€§ï¼Œé€‰å‡ºæœ€ä½³æ–‡æ¡£

```python
diversity_prompt = PromptTemplate(...)
diversity_chain = diversity_prompt | self.llm.with_structured_output(SelectedIndices)

docs_text = "\n".join([f"{i}: {doc.page_content[:50]}..." for i, doc in enumerate(all_docs)])

input_data = {"query": query, "docs": docs_text, "k": k}
selected_indices_result = diversity_chain.invoke(input_data).indices
```

### âœ¨ å«ä¹‰ï¼š

* å°†æ‰€æœ‰æ–‡æ¡£ç¼–å·åï¼Œè¿åŒåŸå§‹ query ä¸€èµ·é€å…¥ GPT-4o
* Prompt ä¼šæŒ‡ç¤ºæ¨¡å‹ï¼šä»è¿™äº›æ–‡æ¡£ä¸­é€‰å‡ºæœ€ç›¸å…³ä¸”å¤šæ ·æ€§çš„ `k` ä¸ªæ–‡æ¡£ï¼ˆæ¯”å¦‚ 4 ä¸ªï¼‰
* æ¨¡å‹åªè¿”å›ä¸€ç»„æ•´æ•°ç´¢å¼•ï¼Œæ¯”å¦‚ `[1, 3, 5, 7]`

---

## â‘£ è¿”å›æœ€ç»ˆæ–‡æ¡£

```python
return [all_docs[i] for i in selected_indices_result if i < len(all_docs)]
```

* æŒ‰ç…§è¿”å›çš„ç´¢å¼•ï¼Œä»åŸå§‹æ–‡æ¡£ä¸­å–å‡ºå¯¹åº”å†…å®¹ã€‚
* æœ€ç»ˆå¾—åˆ°ä¸€ç»„æœ€ä¼˜ç»“æœï¼Œä½œä¸ºè¿™ä¸ªåˆ†æå‹é—®é¢˜çš„ä¸Šä¸‹æ–‡è¾“å…¥ã€‚

---

# âœ… ä½¿ç”¨åœºæ™¯æ€»ç»“

è¿™æ®µé€»è¾‘éå¸¸é€‚ç”¨äºä»¥ä¸‹ç±»å‹çš„é—®é¢˜åœºæ™¯ï¼š

| ä½¿ç”¨åœºæ™¯                  | ä¸¾ä¾‹                   | ä¸ºä»€ä¹ˆé€‚åˆè¿™ä¸ªç­–ç•¥             |
| --------------------- | -------------------- | --------------------- |
| ğŸ“Š ç»¼åˆæ€§åˆ†æå‹é—®é¢˜           | â€œåˆ†æä¸­å›½ä¸ç¾å›½çš„ç»æµç»“æ„å·®å¼‚â€     | éœ€è¦åˆ†è§£å­é—®é¢˜ï¼ˆå·¥ä¸šç»“æ„ã€å°±ä¸šç‡ã€GDPï¼‰ |
| ğŸ“š æ–‡æ¡£æ€»ç»“å‹é—®é¢˜            | â€œè¯·æ€»ç»“è¿™ç¯‡é•¿æ–‡ç« çš„å¤šä¸ªé‡ç‚¹â€      | åˆ†ç‰‡ååˆ†åˆ«æ£€ç´¢ä¸åŒå†…å®¹           |
| â“ å¤æ‚é—®ç­”ç³»ç»Ÿ              | â€œå…¬å¸å»å¹´åœ¨å“ªäº›é¢†åŸŸè·å¾—äº†æœ€å¤šçš„åˆ©æ¶¦ï¼Ÿâ€ | æ‹†åˆ†é¢†åŸŸ + æ£€ç´¢å¤šä¸ªæ¥æº         |
| ğŸ“Œ åŒ»ç–—ã€æ”¿ç­–ã€è´¢ç»ç­‰éœ€è¦å…¨é¢ä¿¡æ¯çš„é—®ç­” | â€œå°æ¹¾çš„å¥ä¿æ”¿ç­–åœ¨ä¸åŒäººç¾¤ä¸­çš„å½±å“â€   | å¿…é¡»è¦†ç›–å¤šè§’åº¦å†…å®¹æ‰èƒ½å›ç­”å‡†ç¡®       |

---

## ğŸ“¦ æ¨¡å—å°è£…ä¼˜åŠ¿

ä½ è¿™ä¸ª `AnalyticalRetrievalStrategy` ç±»å¯ä»¥çµæ´» plug åˆ°ï¼š

* LangChain çš„è‡ªå®šä¹‰ Retriever ç³»ç»Ÿä¸­ï¼ˆæ¯”å¦‚ RAGã€Agentï¼‰
* å¤šç­–ç•¥é€‰æ‹©å™¨ï¼ˆæ¯”å¦‚ `AdaptiveRetriever`ï¼‰
* å¯ä»¥ç»„åˆå„ç§ Retrieval ç­–ç•¥ï¼šäº‹å®å‹ã€è§‚ç‚¹å‹ã€åˆ†æå‹â€¦â€¦

---

## âœ… å°ç»“

| æ­¥éª¤ | åŠŸèƒ½                   | æŠ€æœ¯ç‚¹                          |
| -- | -------------------- | ---------------------------- |
| 1  | LLM è‡ªåŠ¨æ‹†è§£å¤æ‚é—®é¢˜ä¸ºå¤šä¸ªå­é—®é¢˜   | LLM + PromptTemplate + ç»“æ„åŒ–è¾“å‡º |
| 2  | å¯¹æ¯ä¸ªå­é—®é¢˜åšç‹¬ç«‹æ£€ç´¢          | similarity\_searchï¼ˆé€šå¸¸æ˜¯å‘é‡æ•°æ®åº“ï¼‰ |
| 3  | LLM å†æ¬¡ç­›é€‰å‡ºæœ€ç›¸å…³ + å¤šæ ·åŒ–æ–‡æ¡£ | å¤šæ ·æ€§ + ç²¾åº¦ï¼Œé¿å…å†—ä½™                |
| 4  | è¿”å›ç»™ RAG æ¨¡å‹æˆ–é—®ç­”ç³»ç»Ÿä½œä¸ºä¸Šä¸‹æ–‡ | ç”¨äº LLM ç”Ÿæˆæœ€ç»ˆå›ç­”                |

---

å¦‚æœä½ å¸Œæœ›æˆ‘å¸®ä½ ï¼š

* æ‹“å±•æˆå®Œæ•´å¯è¿è¡Œçš„ RAG é¡¹ç›®
* è¡¥å……å­æ¨¡å—ï¼ˆæ¯”å¦‚ `self.db`, `BaseRetrievalStrategy`ï¼‰
* å¢å¼ºç­–ç•¥ï¼ˆåŠ å…¥æ‰“åˆ†ã€å¤šè½®æ£€ç´¢ã€å¤šè¯­è¨€æ”¯æŒï¼‰

æˆ‘å¯ä»¥ç»§ç»­å¸®ä½ æ„å»ºä¸€ä¸ªå®Œæ•´ç‰ˆæœ¬ã€‚éœ€è¦çš„è¯åªç®¡è¯´ï¼
